<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:u="clr-namespace:AcManager.Controls.UserControls" xmlns:mui="http://firstfloorsoftware.com/ModernUI"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:c="clr-namespace:AcManager.Controls" xmlns:t="http://acstuff.ru/app/tools" mc:Ignorable="d">
    <ResourceDictionary.MergedDictionaries>
        <mui:SharedResourceDictionary Source="/AcManager.Controls;component/Assets/IconData.xaml" />
        <mui:SharedResourceDictionary Source="/AcManager.Controls;component/Assets/Converters.xaml" />
        <ResourceDictionary Source="/FirstFloor.ModernUI;component/Assets/TextBlock.xaml" />
        <ResourceDictionary Source="/FirstFloor.ModernUI;component/Assets/Converters.xaml" />
        <ResourceDictionary Source="/FirstFloor.ModernUI;component/Assets/ListBox.xaml" />
        <ResourceDictionary Source="/FirstFloor.ModernUI;component/Themes/ModernButton.xaml" />
    </ResourceDictionary.MergedDictionaries>

    <!--car & track previews-->
    <ToolTip x:Key="CarPreviewTooltip" d:DataContext="{d:DesignInstance t:ServerEntry+CarOrOnlyCarIdEntry}">
        <mui:BooleanSwitch Value="{Binding CarExists}" Margin="4">
            <mui:BooleanSwitch.True>
                <StackPanel>
                    <TextBlock Style="{StaticResource Heading2}" Text="{Binding CarObjectWrapper.Value.DisplayName}" Margin="0 0 0 4" />
                    <u:CarBlock Car="{Binding CarObjectWrapper.Value}" ShowSkinsAndPreview="False" SelectSkin="False" Width="512" MaxHeight="320" />
                </StackPanel>
            </mui:BooleanSwitch.True>
            <mui:BooleanSwitch.False>
                <DockPanel>
                    <Path Data="{StaticResource AlertIconData}" Width="16" Height="16" Fill="{DynamicResource Error}" Stretch="Uniform" x:Name="ErrorIcon"
                            DockPanel.Dock="Left" Margin="0 0 4 0" />
                    <TextBlock>
                        <Run Text="{x:Static c:ControlsStrings.Online_CarIsMissingLabel}" />
                        <Run Text="{Binding CarId, Mode=OneWay}" FontWeight="Bold" />
                    </TextBlock>
                </DockPanel>
            </mui:BooleanSwitch.False>
        </mui:BooleanSwitch>
    </ToolTip>

    <ToolTip x:Key="TrackPreviewTooltip" d:DataContext="{d:DesignInstance t:ServerEntry}">
        <mui:ReferenceSwitch Value="{Binding Track}" Margin="4">
            <mui:ReferenceSwitch.NonNull>
                <StackPanel>
                    <TextBlock Style="{StaticResource Heading2}" Text="{Binding Track.Name}" Margin="0 0 0 4" />
                    <u:TrackBlock Track="{Binding Track}" Width="512" MaxHeight="320" />
                </StackPanel>
            </mui:ReferenceSwitch.NonNull>
            <mui:ReferenceSwitch.Null>
                <DockPanel>
                    <Path Data="{StaticResource AlertIconData}" Width="16" Height="16" Fill="{DynamicResource Error}" Stretch="Uniform" DockPanel.Dock="Left"
                            Margin="0 0 4 0" />
                    <TextBlock>
                        <Run Text="{x:Static c:ControlsStrings.Online_TrackIsMissingLabel}" />
                        <Run Text="{Binding TrackId, Mode=OneWay}" FontWeight="Bold" />
                    </TextBlock>
                </DockPanel>
            </mui:ReferenceSwitch.Null>
        </mui:ReferenceSwitch>
    </ToolTip>

    <!--online-->
    <!--driver & car name-->
    <DataTemplate x:Key="OnlineDriverEntry" DataType="{x:Type t:ServerEntry+CurrentDriver}">
        <DockPanel Width="200">
            <mui:BetterImage Filename="{Binding CarSkin.LiveryImage}" Width="16" Height="16" Margin="4" ClearOnChange="True" />
            <TextBlock Text="{Binding Name}" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" DockPanel.Dock="Top" />
            <TextBlock Text="{Binding Car.DisplayName}" Style="{StaticResource Small}" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" />
        </DockPanel>
    </DataTemplate>

    <!--tooltips for clients-->
    <ToolTip x:Key="ClientsTooltip" d:DataContext="{d:DesignInstance t:ServerEntry}"
            Visibility="{Binding CurrentDrivers.Count, Converter={StaticResource EnumToVisibilityConverter}, ConverterParameter='≠0'}">
        <StackPanel Margin="4">
            <TextBlock Text="{x:Static c:ControlsStrings.Online_DriversOnlineLabel}" Style="{StaticResource Label}" />
            <ItemsControl ItemsSource="{Binding CurrentDrivers}" ScrollViewer.HorizontalScrollBarVisibility="Disabled" MaxHeight="480" MaxWidth="450"
                    ItemTemplate="{StaticResource OnlineDriverEntry}" ItemsPanel="{StaticResource WrapItemsPanel}" />
        </StackPanel>
    </ToolTip>

    <ToolTip x:Key="SessionItemTooltip" d:DataContext="{d:DesignInstance t:ServerEntry+Session}">
        <StackPanel>
            <TextBlock Text="{Binding DisplayType}" HorizontalAlignment="Left" Style="{StaticResource Heading2}" />
            <TextBlock Text="{Binding DisplayDuration}" HorizontalAlignment="Left" Margin="0 4 0 0" />
        </StackPanel>
    </ToolTip>

    <!--session block-->
    <DataTemplate x:Key="SessionItem" DataType="{x:Type t:ServerEntry+Session}">
        <TextBlock Text="{Binding DisplayTypeShort}" x:Name="TextBlock" Foreground="{DynamicResource ButtonText}" Style="{StaticResource Label}"
                Background="{DynamicResource ButtonBackground}" Height="20" Width="20" TextAlignment="Center" Padding="0 2 0 0"
                ToolTip="{StaticResource SessionItemTooltip}" />
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding IsActive}" Value="True">
                <Setter TargetName="TextBlock" Property="Background" Value="{DynamicResource ButtonBackgroundPressed}" />
                <Setter TargetName="TextBlock" Property="Foreground" Value="{DynamicResource ButtonTextPressed}" />
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <!--car block-->
    <DataTemplate x:Key="CarItem" DataType="{x:Type t:ServerEntry+CarOrOnlyCarIdEntry}">
        <TextBlock Text="{Binding CarObjectWrapper.Value.DisplayName}" x:Name="TextBlock" HorizontalAlignment="Center"
                ToolTip="{StaticResource CarPreviewTooltip}" Style="{StaticResource Small}" Margin="4 0" Height="20" Padding="2"
                Background="{DynamicResource ButtonBackground}" />
        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding CarExists}" Value="False">
                <Setter TargetName="TextBlock" Property="Text" Value="{Binding CarId}" />
                <Setter TargetName="TextBlock" Property="Background" Value="{DynamicResource ButtonBackgroundPressed}" />
                <Setter TargetName="TextBlock" Property="Foreground" Value="{DynamicResource ButtonTextPressed}" />
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <ContextMenu x:Key="ListItemContextMenu" d:DataContext="{d:DesignInstance {x:Type t:ServerEntry}}">
        <MenuItem Command="{Binding JoinCommand}">
            <MenuItem.Header>
                <!--TODO: fallback value?-->
                <TextBlock Text="{Binding CarsView.CurrentItem.CarObject, FallbackValue='?', StringFormat={x:Static c:ControlsStrings.Online_JoinUsing}}" />
            </MenuItem.Header>
        </MenuItem>
        <!--TODO: rework this-->
        <MenuItem Header="Add to Recent &amp; Shortcuts" Command="{Binding AddToRecentCommand}" />
    </ContextMenu>

    <!-- lite version -->
    <DataTemplate x:Key="SimpleListItem" DataType="{x:Type t:ServerEntry}">
        <Grid ContextMenu="{StaticResource ListItemContextMenu}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="60" />
                <ColumnDefinition Width="60" />
            </Grid.ColumnDefinitions>

            <Grid.RowDefinitions>
                <RowDefinition Height="20" />
            </Grid.RowDefinitions>

            <DockPanel Grid.Column="0">
                <Path Data="{StaticResource LockIconData}" Width="12" Height="12" Fill="{DynamicResource WindowText}" Stretch="Uniform" Visibility="Hidden"
                        x:Name="PasswordIcon" HorizontalAlignment="Left" DockPanel.Dock="Left" ToolTip="{x:Static c:ControlsStrings.Online_PasswordRequired}"
                        Margin="10 1 2 3" />
                <TextBlock Text="{Binding DisplayName}" FontSize="{DynamicResource SmallFontSize}" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
                        Margin="2" x:Name="DisplayNameText" />
            </DockPanel>

            <TextBlock Text="{Binding DisplayClients}" Grid.Column="1" Style="{StaticResource Small}" HorizontalAlignment="Right" VerticalAlignment="Center" />

            <StackPanel x:Name="PingPanel" Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                <TextBlock Text="{Binding Ping, TargetNullValue='?'}" Style="{StaticResource Small}" />
                <TextBlock Text="{x:Static c:ControlsStrings.Common_MillisecondsPostfix}" Opacity="0.5" Style="{StaticResource Small}" />
            </StackPanel>

            <Path Data="{StaticResource AlertIconData}" Width="16" Height="16" Fill="{DynamicResource Error}" Stretch="Uniform" Visibility="Collapsed"
                    x:Name="ErrorIcon" Grid.Column="2" HorizontalAlignment="Right">
                <Path.ToolTip>
                    <StackPanel>
                        <TextBlock Style="{StaticResource Heading2}" Text="{x:Static c:ControlsStrings.Common_Error}" Margin="4" />
                        <mui:BbCodeBlock BbCode="{Binding ErrorMessage}" Margin="4" />
                    </StackPanel>
                </Path.ToolTip>
            </Path>
        </Grid>

        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding HasErrors}" Value="True">
                <Setter Property="FontWeight" Value="Bold" TargetName="DisplayNameText" />
                <Setter Property="Visibility" Value="Visible" TargetName="ErrorIcon" />
                <Setter Property="Visibility" Value="Collapsed" TargetName="PingPanel" />
            </DataTrigger>
            <DataTrigger Binding="{Binding PasswordRequired}" Value="True">
                <Setter Property="Visibility" Value="Visible" TargetName="PasswordIcon" />
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <!-- heavy version (grid) -->
    <DataTemplate x:Key="DetailedListItem.Grid" DataType="{x:Type t:ServerEntry}">
        <Grid ContextMenu="{StaticResource ListItemContextMenu}" Height="60">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="22" />
                <ColumnDefinition Width="3*" MaxWidth="120" />
                <ColumnDefinition Width="90" />
                <ColumnDefinition Width="1*" />
                <ColumnDefinition Width="32" />
                <ColumnDefinition Width="40" />
                <ColumnDefinition Width="40" />
            </Grid.ColumnDefinitions>

            <Grid.RowDefinitions>
                <RowDefinition Height="30" />
                <RowDefinition Height="30" />
            </Grid.RowDefinitions>

            <!-- first row -->
            <Path Data="{StaticResource LockIconData}" Width="12" Height="12" Fill="{DynamicResource WindowText}" Stretch="Uniform" Visibility="Hidden"
                    x:Name="PasswordIcon" HorizontalAlignment="Left" DockPanel.Dock="Left" ToolTip="{x:Static c:ControlsStrings.Online_PasswordRequired}"
                    Margin="10 1 2 3" Grid.Column="0" Grid.Row="0" Grid.RowSpan="2" />

            <TextBlock Text="{Binding DisplayName}" Style="{StaticResource Heading2}" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" Margin="2"
                    x:Name="DisplayNameText" Grid.Column="1" Grid.Row="0" Grid.ColumnSpan="3" />

            <Image Grid.Row="0" Grid.Column="4" Source="{Binding CountryId, Converter={StaticResource CountryIdToImageConverter}}" Width="24" Height="16"
                    DockPanel.Dock="Left" Margin="0 0 4 0" RenderOptions.BitmapScalingMode="LowQuality" />

            <TextBlock Text="{Binding DisplayClients}" Grid.Row="0" Grid.Column="5" Style="{StaticResource Small}" HorizontalAlignment="Center"
                    VerticalAlignment="Center" ToolTip="{StaticResource ClientsTooltip}" />

            <StackPanel x:Name="PingPanel" Grid.Row="0" Grid.Column="6" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                <TextBlock Text="{Binding Ping, TargetNullValue=?}" Style="{StaticResource Small}" />
                <TextBlock Text="{x:Static c:ControlsStrings.Common_MillisecondsPostfix}" Opacity="0.5" Style="{StaticResource Small}" />
            </StackPanel>

            <Path Data="{StaticResource AlertIconData}" Width="16" Height="16" Fill="{DynamicResource Error}" Stretch="Uniform" Visibility="Collapsed"
                    x:Name="ErrorIcon" Grid.Row="0" Grid.Column="6" HorizontalAlignment="Right">
                <Path.ToolTip>
                    <StackPanel>
                        <TextBlock Style="{StaticResource Heading2}" Text="{x:Static c:ControlsStrings.Common_Error}" Margin="4" />
                        <mui:BbCodeBlock BbCode="{Binding ErrorMessage}" Margin="4" />
                    </StackPanel>
                </Path.ToolTip>
            </Path>

            <!-- second row -->
            <Rectangle Fill="#11888888" Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="6" />

            <TextBlock Grid.Column="1" Grid.Row="1" HorizontalAlignment="Left" VerticalAlignment="Stretch" TextWrapping="NoWrap"
                    TextTrimming="CharacterEllipsis" Margin="2 5 2 5" Padding="2" ToolTip="{StaticResource TrackPreviewTooltip}">
                <TextBlock.Style>
                    <Style TargetType="TextBlock" BasedOn="{StaticResource Small}">
                        <Setter Property="Text" Value="{Binding Track.Name}" />
                        <Setter Property="Background" Value="{DynamicResource ButtonBackground}" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Track}" Value="{x:Null}">
                                <Setter Property="Text" Value="{Binding TrackId}" />
                                <Setter Property="Background" Value="{DynamicResource ButtonBackgroundPressed}" />
                                <Setter Property="Foreground" Value="{DynamicResource ButtonTextPressed}" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>

            <ItemsControl ItemsSource="{Binding Sessions}" Grid.Column="2" Grid.Row="1" HorizontalAlignment="Left" Margin="4 0 4 0"
                    ItemTemplate="{StaticResource SessionItem}" ItemsPanel="{StaticResource HorizontalItemsPanel}" />

            <ItemsControl ItemsSource="{Binding CarsOrTheirIds}" Grid.Column="3" Grid.ColumnSpan="4" Grid.Row="1" HorizontalAlignment="Left"
                    ItemsPanel="{StaticResource HorizontalItemsPanel}" ItemTemplate="{StaticResource CarItem}" />
        </Grid>

        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding HasErrors}" Value="True">
                <Setter Property="FontWeight" Value="Bold" TargetName="DisplayNameText" />
                <Setter Property="Visibility" Value="Visible" TargetName="ErrorIcon" />
                <Setter Property="Visibility" Value="Collapsed" TargetName="PingPanel" />
            </DataTrigger>
            <DataTrigger Binding="{Binding PasswordRequired}" Value="True">
                <Setter Property="Visibility" Value="Visible" TargetName="PasswordIcon" />
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <Style TargetType="c:OnlineListBoxDetailedItem">
        <Setter Property="FocusVisualStyle" Value="{x:Null}" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="c:OnlineListBoxDetailedItem">
                    <mui:Cell Height="60" DataContext="{TemplateBinding Server}">
                        <!--optional lock icon-->
                        <Path x:Name="PasswordIcon" Data="{StaticResource LockIconData}" Width="12" Height="12" Fill="{DynamicResource WindowText}"
                                Stretch="Uniform" VerticalAlignment="Center" HorizontalAlignment="Left"
                                ToolTip="{x:Static c:ControlsStrings.Online_PasswordRequired}" Margin="8 1 0 2" />

                        <!--first row-->
                        <mui:BooleanSwitch x:Name="HasErrorsGroup" Width="40" HorizontalAlignment="Right" VerticalAlignment="Top" Height="30">
                            <mui:BooleanSwitch.True>
                                <Path Data="{StaticResource AlertIconData}" Width="16" Height="16" Fill="{DynamicResource Error}" Stretch="Uniform"
                                        VerticalAlignment="Center">
                                    <Path.ToolTip>
                                        <StackPanel>
                                            <TextBlock Style="{StaticResource Heading2}" Text="{x:Static c:ControlsStrings.Common_Error}" Margin="4" />
                                            <mui:BbCodeBlock x:Name="ErrorMessageGroup" Margin="4" />
                                        </StackPanel>
                                    </Path.ToolTip>
                                </Path>
                            </mui:BooleanSwitch.True>
                            <mui:BooleanSwitch.False>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock x:Name="PingText" Style="{StaticResource Small}" />
                                    <TextBlock Text="{x:Static c:ControlsStrings.Common_MillisecondsPostfix}" Opacity="0.5" Style="{StaticResource Small}" />
                                </StackPanel>
                            </mui:BooleanSwitch.False>
                        </mui:BooleanSwitch>
                        <TextBlock x:Name="DisplayClientsText" Width="40" Style="{StaticResource Small}" HorizontalAlignment="Right" VerticalAlignment="Center"
                                Background="Transparent" Margin="0 0 40 30" Padding="4 0" />
                        <Image x:Name="CountryFlagImage" Width="24" Height="16" Margin="0 7 84 30" HorizontalAlignment="Right" VerticalAlignment="Top"
                                RenderOptions.BitmapScalingMode="LowQuality">
                            <Image.ToolTip>
                                <TextBlock x:Name="CountryName" />
                            </Image.ToolTip>
                        </Image>
                        <TextBlock x:Name="DisplayNameText" Style="{StaticResource Heading2}" FontWeight="Normal" TextWrapping="NoWrap"
                                TextTrimming="CharacterEllipsis" Margin="22 2 130 32" />

                        <!--second row-->
                        <Rectangle Fill="#11888888" Margin="20 30 0 0" />
                        <TextBlock x:Name="TrackNameText" Width="120" HorizontalAlignment="Left" VerticalAlignment="Stretch" TextWrapping="NoWrap"
                                TextTrimming="CharacterEllipsis" Padding="2" Margin="22 35 0 5" />
                        <StackPanel x:Name="SessionsPanel" Orientation="Horizontal" Width="90" HorizontalAlignment="Left" Margin="146 30 0 0" />
                        <StackPanel x:Name="CarsPanel" Orientation="Horizontal" HorizontalAlignment="Left" Margin="240 30 0 0" />
                    </mui:Cell>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <Style x:Key="DetailedPlusItem" TargetType="c:OnlineListBoxDetailedItem">
        <Setter Property="FocusVisualStyle" Value="{x:Null}" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="c:OnlineListBoxDetailedItem">
                    <mui:Cell Height="60" DataContext="{TemplateBinding Server}">
                        <!--optional lock icon-->
                        <Path x:Name="PasswordIcon" Data="{StaticResource LockIconData}" Width="12" Height="12" Fill="{DynamicResource WindowText}"
                                Stretch="Uniform" VerticalAlignment="Center" HorizontalAlignment="Left"
                                ToolTip="{x:Static c:ControlsStrings.Online_PasswordRequired}" Margin="8 1 0 2" />

                        <!--first row-->
                        <mui:BooleanSwitch x:Name="HasErrorsGroup" Width="40" HorizontalAlignment="Right" VerticalAlignment="Top" Height="30">
                            <mui:BooleanSwitch.True>
                                <Path Data="{StaticResource AlertIconData}" Width="16" Height="16" Fill="{DynamicResource Error}" Stretch="Uniform"
                                        VerticalAlignment="Center">
                                    <Path.ToolTip>
                                        <StackPanel>
                                            <TextBlock Style="{StaticResource Heading2}" Text="{x:Static c:ControlsStrings.Common_Error}" Margin="4" />
                                            <mui:BbCodeBlock x:Name="ErrorMessageGroup" Margin="4" />
                                        </StackPanel>
                                    </Path.ToolTip>
                                </Path>
                            </mui:BooleanSwitch.True>
                            <mui:BooleanSwitch.False>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock x:Name="PingText" Style="{StaticResource Small}" />
                                    <TextBlock Text="{x:Static c:ControlsStrings.Common_MillisecondsPostfix}" Opacity="0.5" Style="{StaticResource Small}" />
                                </StackPanel>
                            </mui:BooleanSwitch.False>
                        </mui:BooleanSwitch>
                        <TextBlock x:Name="DisplayClientsText" Width="40" Style="{StaticResource Small}" HorizontalAlignment="Right" VerticalAlignment="Center"
                                Background="Transparent" Margin="0 0 40 30" />
                        <Image x:Name="CountryFlagImage" Width="24" Height="16" Margin="0 7 84 30" HorizontalAlignment="Right" VerticalAlignment="Top"
                                RenderOptions.BitmapScalingMode="LowQuality">
                            <Image.ToolTip>
                                <TextBlock x:Name="CountryName" />
                            </Image.ToolTip>
                        </Image>
                        <TextBlock x:Name="DisplayNameText" FontWeight="Normal" Style="{StaticResource Heading2}" TextWrapping="NoWrap"
                                TextTrimming="CharacterEllipsis" Margin="22 2 130 32" />

                        <!--second row-->
                        <Rectangle Fill="#11888888" Margin="20 30 0 0" />
                        <TextBlock x:Name="TrackNameText" Width="120" HorizontalAlignment="Left" VerticalAlignment="Stretch" TextWrapping="NoWrap"
                                TextTrimming="CharacterEllipsis" Padding="2" Margin="22 35 0 5" />
                        <TextBlock x:Name="TimeLeftText" Width="80" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="146 30 0 3"
                                TextAlignment="Right" />
                        <StackPanel x:Name="SessionsPanel" Orientation="Horizontal" Width="90" HorizontalAlignment="Left" Margin="230 30 0 0" />
                        <StackPanel x:Name="CarsPanel" Orientation="Horizontal" HorizontalAlignment="Left" Margin="324 30 0 0" />
                    </mui:Cell>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- heavy version (custom) -->
    <DataTemplate x:Key="DetailedListItem" DataType="{x:Type t:ServerEntry}">
        <c:OnlineListBoxDetailedItem Server="{Binding}">
            <c:OnlineListBoxDetailedItem.CacheMode>
                <BitmapCache EnableClearType="True" />
            </c:OnlineListBoxDetailedItem.CacheMode>
        </c:OnlineListBoxDetailedItem>
    </DataTemplate>

    <DataTemplate x:Key="DetailedPlusListItem" DataType="{x:Type t:ServerEntry}">
        <c:OnlineListBoxDetailedItem Style="{StaticResource DetailedPlusItem}" Server="{Binding}">
            <c:OnlineListBoxDetailedItem.CacheMode>
                <BitmapCache EnableClearType="True" />
            </c:OnlineListBoxDetailedItem.CacheMode>
        </c:OnlineListBoxDetailedItem>
    </DataTemplate>

    <!-- heavy version (optimized?) -->
    <DataTemplate x:Key="DetailedListItem.Opt" DataType="{x:Type t:ServerEntry}">
        <DockPanel ContextMenu="{StaticResource ListItemContextMenu}" Height="60">
            <mui:BooleanSwitch DockPanel.Dock="Left" Value="{Binding PasswordRequired}" Width="22">
                <Path Data="{StaticResource LockIconData}" Width="12" Height="12" Fill="{DynamicResource WindowText}" Stretch="Uniform"
                        HorizontalAlignment="Left" ToolTip="{x:Static c:ControlsStrings.Online_PasswordRequired}" Margin="10 1 2 3" />
            </mui:BooleanSwitch>

            <DockPanel DockPanel.Dock="Top" Height="30">
                <mui:BooleanSwitch DockPanel.Dock="Right" Width="40" Value="{Binding HasErrors}" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <mui:BooleanSwitch.True>
                        <Path Data="{StaticResource AlertIconData}" Width="16" Height="16" Fill="{DynamicResource Error}" Stretch="Uniform">
                            <Path.ToolTip>
                                <StackPanel>
                                    <TextBlock Style="{StaticResource Heading2}" Text="{x:Static c:ControlsStrings.Common_Error}" Margin="4" />
                                    <mui:BbCodeBlock BbCode="{Binding ErrorMessage}" Margin="4" />
                                </StackPanel>
                            </Path.ToolTip>
                        </Path>
                    </mui:BooleanSwitch.True>
                    <mui:BooleanSwitch.False>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{Binding Ping, TargetNullValue=?}" Style="{StaticResource Small}" />
                            <TextBlock Text="{x:Static c:ControlsStrings.Common_MillisecondsPostfix}" Opacity="0.5" Style="{StaticResource Small}" />
                        </StackPanel>
                    </mui:BooleanSwitch.False>
                </mui:BooleanSwitch>

                <TextBlock DockPanel.Dock="Right" Width="40" Text="{Binding DisplayClients}" Style="{StaticResource Small}" HorizontalAlignment="Center"
                        VerticalAlignment="Center" ToolTip="{StaticResource ClientsTooltip}" />

                <Image DockPanel.Dock="Right" Source="{Binding CountryId, Converter={StaticResource CountryIdToImageConverter}}" Width="24" Height="16"
                        Margin="0 0 4 0" RenderOptions.BitmapScalingMode="LowQuality" />

                <TextBlock Text="{Binding DisplayName}" Style="{StaticResource Heading2}" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" Margin="2"
                        x:Name="DisplayNameText" />
            </DockPanel>

            <!-- second row -->
            <StackPanel Orientation="Horizontal" Background="#11888888">
                <TextBlock Width="120" HorizontalAlignment="Left" VerticalAlignment="Stretch" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
                        Margin="2 5 2 5" Padding="2" ToolTip="{StaticResource TrackPreviewTooltip}">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock" BasedOn="{StaticResource Small}">
                            <Setter Property="Text" Value="{Binding Track.Name}" />
                            <Setter Property="Background" Value="{DynamicResource ButtonBackground}" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Track}" Value="{x:Null}">
                                    <Setter Property="Text" Value="{Binding TrackId}" />
                                    <Setter Property="Background" Value="{DynamicResource ButtonBackgroundPressed}" />
                                    <Setter Property="Foreground" Value="{DynamicResource ButtonTextPressed}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <ItemsControl ItemsSource="{Binding Sessions}" Width="90" HorizontalAlignment="Left" Margin="4 0 4 0"
                        ItemTemplate="{StaticResource SessionItem}" ItemsPanel="{StaticResource HorizontalItemsPanel}" />

                <ItemsControl ItemsSource="{Binding CarsOrTheirIds}" HorizontalAlignment="Left" ItemsPanel="{StaticResource HorizontalItemsPanel}"
                        ItemTemplate="{StaticResource CarItem}" />
            </StackPanel>
        </DockPanel>

        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding HasErrors}" Value="True">
                <Setter Property="FontWeight" Value="Bold" TargetName="DisplayNameText" />
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <!-- heavy version+ (grid) -->
    <DataTemplate x:Key="DetailedPlusListItem.Grid" DataType="{x:Type t:ServerEntry}">
        <Grid ContextMenu="{StaticResource ListItemContextMenu}" Height="60">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="22" />
                <ColumnDefinition Width="3*" MaxWidth="120" />
                <ColumnDefinition Width="60" />
                <ColumnDefinition Width="90" />
                <ColumnDefinition Width="1*" />
                <ColumnDefinition Width="120" />
                <ColumnDefinition Width="40" />
                <ColumnDefinition Width="40" />
            </Grid.ColumnDefinitions>

            <Grid.RowDefinitions>
                <RowDefinition Height="30" />
                <RowDefinition Height="30" />
            </Grid.RowDefinitions>

            <!-- first row -->
            <Path Data="{StaticResource LockIconData}" Width="12" Height="12" Fill="{DynamicResource WindowText}" Stretch="Uniform" Visibility="Hidden"
                    x:Name="PasswordIcon" HorizontalAlignment="Left" DockPanel.Dock="Left" ToolTip="{x:Static c:ControlsStrings.Online_PasswordRequired}"
                    Margin="10 1 2 3" Grid.Column="0" Grid.Row="0" Grid.RowSpan="2" />

            <TextBlock Text="{Binding DisplayName}" Style="{StaticResource Heading2}" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" Margin="2"
                    x:Name="DisplayNameText" Grid.Column="1" Grid.Row="0" Grid.ColumnSpan="4" />

            <DockPanel Grid.Row="0" Grid.Column="5" VerticalAlignment="Center" HorizontalAlignment="Left">
                <Image Source="{Binding CountryId, Converter={StaticResource CountryIdToImageConverter}}" HorizontalAlignment="Right" Width="24" Height="16"
                        DockPanel.Dock="Left" Margin="0 0 4 0" RenderOptions.BitmapScalingMode="LowQuality" />
                <TextBlock Text="{Binding Country}" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" Style="{StaticResource Small}" />
            </DockPanel>

            <TextBlock Text="{Binding DisplayClients}" Grid.Row="0" Grid.Column="6" Style="{StaticResource Small}" HorizontalAlignment="Center"
                    VerticalAlignment="Center" ToolTip="{StaticResource ClientsTooltip}" />

            <StackPanel x:Name="PingPanel" Grid.Row="0" Grid.Column="7" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                <TextBlock Text="{Binding Ping, TargetNullValue=?}" Style="{StaticResource Small}" />
                <TextBlock Text="{x:Static c:ControlsStrings.Common_MillisecondsPostfix}" Opacity="0.5" Style="{StaticResource Small}" />
            </StackPanel>

            <Path Data="{StaticResource AlertIconData}" Width="16" Height="16" Fill="{DynamicResource Error}" Stretch="Uniform" Visibility="Collapsed"
                    x:Name="ErrorIcon" Grid.Row="0" Grid.Column="7" HorizontalAlignment="Right">
                <Path.ToolTip>
                    <StackPanel>
                        <TextBlock Style="{StaticResource Heading2}" Text="{x:Static c:ControlsStrings.Common_Error}" Margin="4" />
                        <mui:BbCodeBlock BbCode="{Binding ErrorMessage}" Margin="4" />
                    </StackPanel>
                </Path.ToolTip>
            </Path>

            <!-- second row -->
            <Rectangle Fill="#11888888" Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="6" />

            <TextBlock Grid.Column="1" Grid.Row="1" HorizontalAlignment="Left" VerticalAlignment="Stretch" TextWrapping="NoWrap"
                    TextTrimming="CharacterEllipsis" Margin="2 5 2 5" Padding="2" ToolTip="{StaticResource TrackPreviewTooltip}">
                <TextBlock.Style>
                    <Style TargetType="TextBlock" BasedOn="{StaticResource Small}">
                        <Setter Property="Text" Value="{Binding Track.Name}" />
                        <Setter Property="Background" Value="{DynamicResource ButtonBackground}" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Track}" Value="{x:Null}">
                                <Setter Property="Text" Value="{Binding TrackId}" />
                                <Setter Property="Background" Value="{DynamicResource ButtonBackgroundPressed}" />
                                <Setter Property="Foreground" Value="{DynamicResource ButtonTextPressed}" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>

            <TextBlock Grid.Column="2" Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="4 -2 0 1" Text="{Binding DisplayTimeLeft}" />
            <ItemsControl ItemsSource="{Binding Sessions}" Grid.Column="3" Grid.Row="1" HorizontalAlignment="Left" Margin="4 0 4 0"
                    ItemTemplate="{StaticResource SessionItem}" ItemsPanel="{StaticResource HorizontalItemsPanel}" />

            <ItemsControl ItemsSource="{Binding CarsOrTheirIds}" Grid.Column="4" Grid.ColumnSpan="4" Grid.Row="1" HorizontalAlignment="Left"
                    ItemsPanel="{StaticResource HorizontalItemsPanel}" ItemTemplate="{StaticResource CarItem}" />
        </Grid>

        <DataTemplate.Triggers>
            <DataTrigger Binding="{Binding HasErrors}" Value="True">
                <Setter Property="FontWeight" Value="Bold" TargetName="DisplayNameText" />
                <Setter Property="Visibility" Value="Visible" TargetName="ErrorIcon" />
                <Setter Property="Visibility" Value="Collapsed" TargetName="PingPanel" />
            </DataTrigger>
            <DataTrigger Binding="{Binding PasswordRequired}" Value="True">
                <Setter Property="Visibility" Value="Visible" TargetName="PasswordIcon" />
            </DataTrigger>
        </DataTemplate.Triggers>
    </DataTemplate>

    <Style x:Key="SimpledListItemContainer" TargetType="ListBoxItem" BasedOn="{StaticResource FlatListBoxItem}" />

    <Style x:Key="DetailedListItemContainer" TargetType="ListBoxItem" BasedOn="{StaticResource FlatListBoxItem}">
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="ListBoxItem">
                    <Border Background="Transparent" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}"
                            Padding="{TemplateBinding Padding}" SnapsToDevicePixels="True">
                        <Grid>
                            <Rectangle x:Name="Bd" Fill="{TemplateBinding Background}" HorizontalAlignment="Left" Width="4" />
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                    VerticalAlignment="{TemplateBinding VerticalContentAlignment}" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" />
                        </Grid>
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter TargetName="Bd" Property="Fill" Value="{DynamicResource ItemBackgroundHover}" />
                        </Trigger>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter TargetName="Bd" Property="Fill" Value="{DynamicResource ItemBackgroundSelected}" />
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>

        <Style.Triggers>
            <Trigger Property="IsSelected" Value="True">
                <Setter Property="Foreground" Value="{DynamicResource ItemText}" />
                <Setter Property="FontWeight" Value="Normal" />
            </Trigger>
        </Style.Triggers>
    </Style>

    <!--quick filter buttons-->
    <Style TargetType="{x:Type mui:ModernToggleButton}" BasedOn="{StaticResource {x:Type mui:ModernButton}}">
        <Setter Property="EllipseDiameter" Value="12" />
        <Setter Property="Margin" Value="4 0 0 0" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type mui:ModernToggleButton}">
                    <Grid Background="Transparent" Margin="{TemplateBinding Padding}" Width="{TemplateBinding EllipseDiameter}"
                            Height="{TemplateBinding EllipseDiameter}">
                        <Path x:Name="IconPath" Data="{TemplateBinding IconData}" Fill="{TemplateBinding Foreground}" Stretch="Uniform"
                                SnapsToDevicePixels="True" />
                        <Path Data="F1 M 60,0 L0,60 L4,64 L64,4 Z" Fill="Red" Stretch="Uniform"
                                Visibility="{TemplateBinding IsChecked, Converter={StaticResource BooleanToVisibilityConverter}}" SnapsToDevicePixels="True"
                                Margin="-2" />
                    </Grid>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Foreground" Value="{DynamicResource ModernButtonTextHover}" />
                        </Trigger>
                        <Trigger Property="IsPressed" Value="True">
                            <Setter Property="Foreground" Value="{DynamicResource ModernButtonTextPressed}" />
                            <Setter TargetName="IconPath" Property="Fill" Value="{DynamicResource ModernButtonIconForegroundPressed}" />
                        </Trigger>
                        <Trigger Property="IsEnabled" Value="False">
                            <Setter Property="Foreground" Value="{DynamicResource ModernButtonTextDisabled}" />
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!--quick filter buttons (big)-->
    <Style x:Key="BigButton" TargetType="{x:Type mui:ModernButton}" BasedOn="{StaticResource {x:Type mui:ModernButton}}">
        <Setter Property="Width" Value="48" />
        <Setter Property="Height" Value="48" />
        <Setter Property="EllipseDiameter" Value="24" />
        <Setter Property="Margin" Value="0 0 8 0" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type mui:ModernButton}">
                    <DockPanel Background="Transparent">
                        <TextBlock TextAlignment="Center" Margin="0 4 0 0" Text="{TemplateBinding Content}" Style="{StaticResource Label}"
                                DockPanel.Dock="Bottom" />
                        <Grid Margin="{TemplateBinding Padding}" Width="{TemplateBinding EllipseDiameter}" Height="{TemplateBinding EllipseDiameter}">
                            <Path x:Name="IconPath" Data="{TemplateBinding IconData}" Fill="{TemplateBinding Foreground}" Stretch="Uniform"
                                    SnapsToDevicePixels="True" />
                        </Grid>
                    </DockPanel>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Foreground" Value="{DynamicResource ModernButtonTextHover}" />
                        </Trigger>
                        <Trigger Property="IsPressed" Value="True">
                            <Setter Property="Foreground" Value="{DynamicResource ModernButtonTextPressed}" />
                            <Setter TargetName="IconPath" Property="Fill" Value="{DynamicResource ModernButtonIconForegroundPressed}" />
                        </Trigger>
                        <Trigger Property="IsEnabled" Value="False">
                            <Setter Property="Foreground" Value="{DynamicResource ModernButtonTextDisabled}" />
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <Style x:Key="BigToggleButton" TargetType="{x:Type mui:ModernToggleButton}" BasedOn="{StaticResource {x:Type mui:ModernButton}}">
        <Setter Property="Width" Value="48" />
        <Setter Property="Height" Value="48" />
        <Setter Property="EllipseDiameter" Value="24" />
        <Setter Property="Margin" Value="0 0 8 0" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type mui:ModernToggleButton}">
                    <DockPanel Background="Transparent">
                        <TextBlock TextAlignment="Center" Margin="0 4 0 0" Text="{TemplateBinding Content}" Style="{StaticResource Label}"
                                DockPanel.Dock="Bottom" />
                        <Grid Margin="{TemplateBinding Padding}" Width="{TemplateBinding EllipseDiameter}" Height="{TemplateBinding EllipseDiameter}">
                            <Path x:Name="IconPath" Data="{TemplateBinding IconData}" Fill="{TemplateBinding Foreground}" Stretch="Uniform"
                                    SnapsToDevicePixels="True" />
                            <Path Data="F1 M 60,0 L0,60 L4,64 L64,4 Z" Fill="Red" Stretch="Uniform"
                                    Visibility="{TemplateBinding IsChecked, Converter={StaticResource BooleanToVisibilityConverter}}" SnapsToDevicePixels="True"
                                    Margin="-2" />
                        </Grid>
                    </DockPanel>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Foreground" Value="{DynamicResource ModernButtonTextHover}" />
                        </Trigger>
                        <Trigger Property="IsPressed" Value="True">
                            <Setter Property="Foreground" Value="{DynamicResource ModernButtonTextPressed}" />
                            <Setter TargetName="IconPath" Property="Fill" Value="{DynamicResource ModernButtonIconForegroundPressed}" />
                        </Trigger>
                        <Trigger Property="IsEnabled" Value="False">
                            <Setter Property="Foreground" Value="{DynamicResource ModernButtonTextDisabled}" />
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>
</ResourceDictionary>