<UserControl x:Class="AcManager.Pages.Drive.Online" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008" xmlns:mui="http://firstfloorsoftware.com/ModernUI"
        xmlns:dr="clr-namespace:AcManager.Pages.Drive" xmlns:mn="clr-namespace:AcManager.Tools.AcManagersNew;assembly=AcManager.Tools"
        xmlns:h="clr-namespace:FirstFloor.ModernUI.Windows.Attached;assembly=FirstFloor.ModernUI"
        xmlns:on="clr-namespace:AcManager.Tools.Managers.Online;assembly=AcManager.Tools"
        xmlns:he="clr-namespace:AcManager.Tools.Helpers;assembly=AcManager.Tools" xmlns:g="clr-namespace:AcManager" xmlns:c="http://acstuff.ru/app/controls"
        mc:Ignorable="d" d:DesignHeight="300" d:DesignWidth="300" Loaded="Online_OnLoaded" Unloaded="Online_OnUnloaded" SizeChanged="Online_OnSizeChanged"
        h:InputBindingBehavior.PropagateInputBindingsToWindow="True" d:DataContext="{d:DesignInstance dr:Online+OnlineViewModel}">
    <UserControl.Resources>
        <mui:SharedResourceDictionary Source="/AcManager.Controls;component/Assets/OnlineSpecific.xaml" />
    </UserControl.Resources>

    <Grid Style="{StaticResource ContentRoot}">
        <!-- loading -->
        <ProgressBar IsIndeterminate="True" HorizontalAlignment="Stretch" VerticalAlignment="Top" Height="4" Margin="20 0 20 0"
                Visibility="{Binding Manager.Status, Converter={StaticResource EnumToVisibilityConverter}, ConverterParameter={x:Static mn:AsyncScanManagerStatus.Loading}}" />

        <!-- error -->
        <StackPanel Visibility="{Binding Manager.Status, Converter={StaticResource EnumToVisibilityConverter}, 
                ConverterParameter={x:Static mn:AsyncScanManagerStatus.Error}}" Margin="40 0 40 0" HorizontalAlignment="Center" VerticalAlignment="Center">
            <TextBlock Style="{StaticResource Heading1}" Text="{x:Static c:ControlsStrings.Common_Error}" />
            <mui:BbCodeBlock BbCode="{Binding Manager.ErrorMessage}" Margin="20" />
            <Button Command="{Binding Manager.RefreshListCommand}" Content="{x:Static c:ControlsStrings.Common_TryAgain}" Margin="20 0 20 0"
                    Visibility="{Binding Manager.ErrorFatal, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=inverse}" />
        </StackPanel>

        <!-- list -->
        <Grid Visibility="{Binding Manager.Status, Converter={StaticResource EnumToVisibilityConverter}, 
                ConverterParameter={x:Static mn:AsyncScanManagerStatus.Ready}}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition />
                <ColumnDefinition Width="9" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <Grid Grid.Column="0" Visibility="{Binding MainList.Count, Converter={StaticResource EnumToVisibilityConverter}, ConverterParameter=≠0}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="2" Margin="{StaticResource StatusMargin}" Foreground="{DynamicResource WindowTextReadOnly}"
                        Text="{Binding MainList.Count, Mode=OneWay, Converter={StaticResource PluralizingConverter}, ConverterParameter='{}{0} server'}">
                    <TextBlock.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="{x:Static g:AppStrings.Online_SortByName}" Command="{Binding ChangeSortingCommand}" CommandParameter="{x:Null}"
                                    IsChecked="{Binding SortingMode.Id, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={x:Null}, Mode=OneWay}" />
                            <MenuItem Header="{x:Static g:AppStrings.Online_SortByDrivers}" Command="{Binding ChangeSortingCommand}" CommandParameter="drivers"
                                    IsChecked="{Binding SortingMode.Id, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter='drivers', Mode=OneWay}" />
                            <MenuItem Header="{x:Static g:AppStrings.Online_SortByCapacity}" Command="{Binding ChangeSortingCommand}"
                                    CommandParameter="capacity"
                                    IsChecked="{Binding SortingMode.Id, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter='capacity', Mode=OneWay}" />
                            <MenuItem Header="{x:Static g:AppStrings.Online_SortByCarsNumber}" Command="{Binding ChangeSortingCommand}" CommandParameter="cars"
                                    IsChecked="{Binding SortingMode.Id, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter='cars', Mode=OneWay}" />
                            <MenuItem Header="{x:Static g:AppStrings.Online_SortByPing}" Command="{Binding ChangeSortingCommand}" CommandParameter="ping"
                                    IsChecked="{Binding SortingMode.Id, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter='ping', Mode=OneWay}" />
                            <Separator />
                            <MenuItem Header="{x:Static g:AppStrings.Toolbar_Reload}" InputGestureText="Ctrl+R" Command="{Binding Manager.RefreshListCommand}" />
                            <MenuItem Header="{x:Static g:AppStrings.Online_AddByIp}" InputGestureText="Ctrl+A" Command="{Binding AddNewServerCommand}" />
                        </ContextMenu>
                    </TextBlock.ContextMenu>
                    <TextBlock.ToolTip>
                        <ToolTip>
                            <TextBlock>
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="{x:Static g:AppStrings.Online_Pinged}">
                                        <Binding Path="Manager.Pinged" />
                                        <Binding Path="Manager.WrappersList.Count" Converter="{StaticResource PluralizingConverter}"
                                                ConverterParameter="{x:Static g:AppStrings.Online_ServersFormat}" />
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                        </ToolTip>
                    </TextBlock.ToolTip>
                </TextBlock>

                <ProgressBar Visibility="{Binding Manager.PingingInProcess, Converter={StaticResource BooleanToVisibilityConverter}}" Minimum="0"
                        Maximum="{Binding Manager.WrappersList.Count}" Value="{Binding Manager.Pinged}" IsHitTestVisible="False" Grid.Row="2"
                        VerticalAlignment="Bottom" Margin="2" Height="2" />

                <StackPanel Grid.Row="2" Orientation="Horizontal" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="{StaticResource StatusMargin}"
                        Visibility="{Binding CompactUi, Source={x:Static he:SettingsHolder.Online}, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <mui:ModernToggleButton IconData="{StaticResource ListCheckIconData}" IsChecked="{Binding FilterBooking}"
                            ToolTip="{x:Static g:AppStrings.Online_FilterWithBooking}" />
                    <mui:ModernToggleButton IconData="{StaticResource EmptyGlassIconData}" IsChecked="{Binding FilterEmpty}"
                            ToolTip="{x:Static g:AppStrings.Online_FilterEmpty}" />
                    <mui:ModernToggleButton IconData="{StaticResource FullGlassIconData}" IsChecked="{Binding FilterFull}"
                            ToolTip="{x:Static g:AppStrings.Online_FilterFull}" />
                    <mui:ModernToggleButton IconData="{StaticResource LockIconData}" IsChecked="{Binding FilterPassword}"
                            ToolTip="{x:Static g:AppStrings.Online_FilterPassword}" />
                    <mui:ModernToggleButton IconData="{StaticResource QuestionMarkIconData}" IsChecked="{Binding FilterMissing}"
                            ToolTip="{x:Static g:AppStrings.Online_FilterMissing}" />
                </StackPanel>

                <StackPanel Grid.Row="2" Orientation="Horizontal" VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="{StaticResource StatusMargin}"
                        Visibility="{Binding CompactUi, Source={x:Static he:SettingsHolder.Online}, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=inverse}">
                    <mui:ModernButton EllipseStrokeThickness="0" IconData="{StaticResource RefreshIconData}" Command="{Binding Manager.RefreshListCommand}" />
                </StackPanel>

                <DockPanel Grid.Row="0" x:Name="BigButtons"
                        Visibility="{Binding CompactUi, Source={x:Static he:SettingsHolder.Online}, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=inverse}">
                    <StackPanel Orientation="Horizontal" Margin="16 0 0 16" DockPanel.Dock="Left">
                        <mui:ModernToggleButton Style="{StaticResource BigToggleButton}" IconData="{StaticResource ListCheckIconData}"
                                IsChecked="{Binding FilterBooking}" ToolTip="{x:Static g:AppStrings.Online_FilterWithBooking}"
                                Content="{x:Static g:AppStrings.Online_FilterBooking_Short}" />
                        <mui:ModernToggleButton Style="{StaticResource BigToggleButton}" IconData="{StaticResource EmptyGlassIconData}"
                                IsChecked="{Binding FilterEmpty}" ToolTip="{x:Static g:AppStrings.Online_FilterEmpty}"
                                Content="{x:Static g:AppStrings.Online_FilterEmpty_Short}" />
                        <mui:ModernToggleButton Style="{StaticResource BigToggleButton}" IconData="{StaticResource FullGlassIconData}"
                                IsChecked="{Binding FilterFull}" ToolTip="{x:Static g:AppStrings.Online_FilterFull}"
                                Content="{x:Static g:AppStrings.Online_FilterFull_Short}" />
                        <mui:ModernToggleButton Style="{StaticResource BigToggleButton}" IconData="{StaticResource LockIconData}"
                                IsChecked="{Binding FilterPassword}" ToolTip="{x:Static g:AppStrings.Online_FilterPassword}"
                                Content="{x:Static g:AppStrings.Online_FilterPassword_Short}" />
                        <mui:ModernToggleButton Style="{StaticResource BigToggleButton}" IconData="{StaticResource QuestionMarkIconData}"
                                IsChecked="{Binding FilterMissing}" ToolTip="{x:Static g:AppStrings.Online_FilterMissing}"
                                Content="{x:Static g:AppStrings.Online_FilterMissing_Short}" />
                    </StackPanel>

                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Left" Margin="8 0 8 16"
                            Visibility="{Binding ActualWidth, ElementName=BigButtons, Converter={StaticResource MoreToVisibilityConverter}, ConverterParameter=430}">
                        <TextBlock Style="{StaticResource Label}" Margin="0 0 0 8" Text="{x:Static g:AppStrings.Online_SortByLabel}" />
                        <ComboBox Width="120" ItemsSource="{Binding SortingModes}" SelectedItem="{Binding SortingMode}" DisplayMemberPath="DisplayName" />
                    </StackPanel>
                </DockPanel>

                <ListBox Grid.Row="1" x:Name="ServersListBox" ItemsSource="{Binding MainList}" VirtualizingPanel.IsVirtualizing="True"
                        VirtualizingPanel.VirtualizationMode="Recycling" IsSynchronizedWithCurrentItem="True" ItemTemplate="{StaticResource SimpleListItem}"
                        VirtualizingStackPanel.CacheLength="1,1" VirtualizingStackPanel.CacheLengthUnit="Page" VirtualizingStackPanel.ScrollUnit="Pixel"
                        Style="{StaticResource VirtualizingListBox}" />
            </Grid>

            <Rectangle Visibility="{Binding SelectedSource, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=inverse}"
                    Fill="{DynamicResource SeparatorBackground}" Grid.Column="1" Width="1" HorizontalAlignment="Center" VerticalAlignment="Stretch" />
            <mui:ModernFrame Grid.Column="2" Source="{Binding SelectedSource}" Margin="16 0 16 0" TransitionName="Normal" Width="450" />

            <ProgressBar IsIndeterminate="True" Margin="20" Width="320" Height="4" HorizontalAlignment="Center" VerticalAlignment="Bottom" Grid.ColumnSpan="3"
                    Grid.Column="0" Visibility="{Binding Manager.BackgroundLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                    IsHitTestVisible="False" />

            <!--empty-->
            <StackPanel Visibility="{Binding MainList.Count, Converter={StaticResource EnumToVisibilityConverter}, ConverterParameter=0}" Grid.ColumnSpan="3"
                    Grid.Column="0" Margin="0 0 0 100" HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="{x:Static g:AppStrings.Online_NothingToDisplay}" Style="{StaticResource Heading1}" TextAlignment="Center" />
                <StackPanel Orientation="Horizontal" Margin="8 16 0 0">
                    <mui:ModernToggleButton Style="{StaticResource BigToggleButton}" IconData="{StaticResource ListCheckIconData}"
                            IsChecked="{Binding FilterBooking}" ToolTip="{x:Static g:AppStrings.Online_FilterWithBooking}"
                            Content="{x:Static g:AppStrings.Online_FilterBooking_Short}" />
                    <mui:ModernToggleButton Style="{StaticResource BigToggleButton}" IconData="{StaticResource EmptyGlassIconData}"
                            IsChecked="{Binding FilterEmpty}" ToolTip="{x:Static g:AppStrings.Online_FilterEmpty}"
                            Content="{x:Static g:AppStrings.Online_FilterEmpty_Short}" />
                    <mui:ModernToggleButton Style="{StaticResource BigToggleButton}" IconData="{StaticResource FullGlassIconData}"
                            IsChecked="{Binding FilterFull}" ToolTip="{x:Static g:AppStrings.Online_FilterFull}"
                            Content="{x:Static g:AppStrings.Online_FilterFull_Short}" />
                    <mui:ModernToggleButton Style="{StaticResource BigToggleButton}" IconData="{StaticResource LockIconData}"
                            IsChecked="{Binding FilterPassword}" ToolTip="{x:Static g:AppStrings.Online_FilterPassword}"
                            Content="{x:Static g:AppStrings.Online_FilterPassword_Short}" />
                    <mui:ModernToggleButton Style="{StaticResource BigToggleButton}" IconData="{StaticResource QuestionMarkIconData}"
                            IsChecked="{Binding FilterMissing}" ToolTip="{x:Static g:AppStrings.Online_FilterMissing}"
                            Content="{x:Static g:AppStrings.Online_FilterMissing_Short}" />
                    <Separator />
                    <mui:ModernButton Style="{StaticResource BigButton}" IconData="{StaticResource RefreshIconData}"
                            Command="{Binding Manager.RefreshListCommand}" Content="Refresh" />
                </StackPanel>
                <Button Margin="0 8 0 0" Command="{Binding AddNewServerCommand}"
                        Visibility="{Binding Type, Converter={StaticResource EnumToVisibilityConverter}, ConverterParameter={x:Static on:OnlineManagerType.Recent}}">
                    <DockPanel IsHitTestVisible="False">
                        <Path Data="{StaticResource AddIconData}" Width="10" Height="10"
                                Fill="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=Foreground}" Stretch="Uniform" DockPanel.Dock="Left"
                                Margin="0 0 4 0" VerticalAlignment="Center" SnapsToDevicePixels="True" />
                        <TextBlock Text="{x:Static g:AppStrings.Online_AddNewServer}" />
                    </DockPanel>
                </Button>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
