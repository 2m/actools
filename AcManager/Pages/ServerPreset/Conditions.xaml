<UserControl x:Class="AcManager.Pages.ServerPreset.Conditions" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008" xmlns:local="clr-namespace:AcManager.Pages.ServerPreset"
    xmlns:mui="http://firstfloorsoftware.com/ModernUI" xmlns:t="http://acstuff.ru/app/tools" xmlns:c="http://acstuff.ru/app/controls"
    xmlns:g="clr-namespace:AcManager" xmlns:a="clr-namespace:AcTools;assembly=AcTools" xmlns:i="http://schemas.microsoft.com/expression/2010/interactivity"
    mc:Ignorable="d" d:DataContext="{d:DesignInstance local:SelectedPage+ViewModel}">
  <UserControl.Resources>
    <ResourceDictionary>
      <ResourceDictionary.MergedDictionaries>
        <mui:SharedResourceDictionary Source="/AcManager.Controls;component/Assets/Converters.xaml" />
        <mui:SharedResourceDictionary Source="/AcManager.Controls;component/Assets/SettingsSpecific.xaml" />
        <mui:SharedResourceDictionary Source="/AcManager.Controls;component/Assets/IconData.xaml" />
      </ResourceDictionary.MergedDictionaries>

      <DataTemplate x:Key="WeatherDataTemplate" DataType="{x:Type t:ServerWeatherEntry}">
        <StackPanel Style="{StaticResource SettingsPanel}" Width="400" Margin="8" Background="Transparent" TextBlock.FontWeight="Normal"
            mui:ContextMenuAdvancement.PropagateToChildren="True">
          <StackPanel.ContextMenu>
            <ContextMenu>
              <MenuItem Header="Temperature In Relative Range" IsCheckable="True" IsChecked="{mui:Stored 'temperatureRelativeRange=True'}" />
              <Separator />
              <MenuItem Header="Wind Speed In Meters Per Second" IsCheckable="True" IsChecked="{mui:Stored windSpeedInMetersPerSecond}" />
              <MenuItem Header="Wind Speed In Relative Range" IsCheckable="True" IsChecked="{mui:Stored 'windSpeedRelativeRange=True'}" />
              <MenuItem Header="Wind Direction In Degrees" IsCheckable="True" IsChecked="{mui:Stored windDirectionInDegrees}" />
              <MenuItem Header="Wind Speed In Relative Range" IsCheckable="True" IsChecked="{mui:Stored 'windSpeedRelativeRange=True'}" />
            </ContextMenu>
          </StackPanel.ContextMenu>

          <TextBlock Text="{Binding Index, Converter={StaticResource SumConverter}, ConverterParameter=1, StringFormat='{}#{0}'}"
              Style="{StaticResource Small}" Margin="0 0 0 8" />

          <c:WeatherComboBox SelectedWeather="{Binding Weather}" Margin="0 0 0 8" />

          <DockPanel>
            <c:DoubleTemperatureValueLabel Padding="8 0 0 0" RelativeRangeBase="{Binding BaseAmbientTemperature, StringFormat='{}{0:F1}'}"
                RelativeRangeHalf="{Binding AmbientTemperatureVariationHalf, StringFormat='{}{0:F1}'}" Background="Transparent"
                Content="{x:Static g:AppStrings.Drive_Temperature}" Width="240" JoinIfEqual="True" RelativeRange="{mui:Stored 'temperatureRelativeRange=True'}" />
            <mui:DoubleSlider TickFrequency="6" TickPlacement="BottomRight" Value="{Binding BaseAmbientTemperature}"
                Range="{Binding AmbientTemperatureVariation}" BindingMode="PositionRange" Minimum="{x:Static a:CommonAcConsts.TemperatureMinimum}"
                Maximum="{x:Static a:CommonAcConsts.TemperatureMaximum}" />
          </DockPanel>

          <DockPanel>
            <DockPanel.ToolTip>
              <ToolTip Content="{Binding RecommendedRoadTemperature}" ContentStringFormat="{}Recommended road temperature: {0:F1} °C" />
            </DockPanel.ToolTip>
            <c:DoubleTemperatureValueLabel Padding="8 0 0 0" RelativeRangeBase="{Binding BaseRoadTemperature, StringFormat='{}{0:F1}'}"
                RelativeRangeHalf="{Binding RoadTemperatureVariationHalf, StringFormat='{}{0:F1}'}" Background="Transparent" Content="Road temperature"
                Width="240" JoinIfEqual="True" RelativeRange="{mui:Stored 'temperatureRelativeRange=True'}" />
            <mui:DoubleSlider TickFrequency="6" TickPlacement="BottomRight" Value="{Binding BaseRoadTemperature}" Range="{Binding RoadTemperatureVariation}"
                BindingMode="PositionRange" Minimum="{x:Static a:CommonAcConsts.TemperatureMinimum}" Maximum="{x:Static a:CommonAcConsts.TemperatureMaximum}" />
          </DockPanel>

          <DockPanel Margin="0 4 0 0">
            <mui:RoundSlider Minimum="0" Maximum="360" TickFrequency="22.5" Value="{Binding WindDirectionFlipped}" DockPanel.Dock="Right" Margin="4 -14 0 0"
                TickPlacement="Both" IsSnapToTickEnabled="{Binding Value, ElementName=WindDirectionSwitch, Converter={StaticResource InvertBooleanConverter}}">
              <mui:RoundSlider.Content>
                <Viewbox Stretch="Uniform" StretchDirection="DownOnly" HorizontalAlignment="Center" VerticalAlignment="Center" Width="24" Height="24">
                  <mui:BooleanSwitch x:Name="WindDirectionSwitch">
                    <mui:BooleanSwitch.Value>
                      <MultiBinding Converter="{StaticResource AndConverter}">
                        <!--<Binding Path="RandomWindDirection" Converter="{StaticResource InvertBooleanConverter}" />-->
                        <mui:Stored Key="windDirectionInDegrees" />
                      </MultiBinding>
                    </mui:BooleanSwitch.Value>
                    <mui:BooleanSwitch.False>
                      <TextBlock Text="{Binding DisplayWindDirection}" Style="{StaticResource Label}" Padding="0 0 0 2" />
                    </mui:BooleanSwitch.False>
                    <mui:BooleanSwitch.True>
                      <mui:ValueLabel Value="{Binding WindDirection, StringFormat='{}{0:F0}'}" Postfix="°" VerticalAlignment="Center" Padding="3 0 0 0"
                          Margin="0 1 0 -1" />
                    </mui:BooleanSwitch.True>
                  </mui:BooleanSwitch>
                </Viewbox>
              </mui:RoundSlider.Content>
            </mui:RoundSlider>

            <mui:BooleanSwitch Value="{mui:Stored windSpeedInMetersPerSecond}" Margin="0 0 0 -2" DockPanel.Dock="Top" HorizontalAlignment="Left">
              <mui:BooleanSwitch.True>
                <mui:DoubleValueLabel Padding="8 0 0 0" Content="Wind" Postfix=" m/s" JoinIfEqual="True"
                    RelativeRange="{mui:Stored 'windSpeedRelativeRange=True'}" RelativeRangeStringFormat="F1"
                    Value="{Binding WindSpeedMin, StringFormat='{}{0:F1}', Converter={StaticResource MultiplyConverter}, ConverterParameter=0.277778}"
                    SecondValue="{Binding WindSpeedMax, StringFormat='{}{0:F1}', Converter={StaticResource MultiplyConverter}, ConverterParameter=0.277778}" />
              </mui:BooleanSwitch.True>
              <mui:BooleanSwitch.False>
                <mui:DoubleValueLabel Padding="8 0 0 0" Content="Wind" Postfix=" km/h" JoinIfEqual="True"
                    RelativeRange="{mui:Stored 'windSpeedRelativeRange=True'}" RelativeRangeStringFormat="F1" Value="{Binding WindSpeedMin}"
                    SecondValue="{Binding WindSpeedMax}" />
              </mui:BooleanSwitch.False>
            </mui:BooleanSwitch>

            <mui:DoubleSlider Minimum="0" Maximum="35" From="{Binding WindSpeedMin}" To="{Binding WindSpeedMax}" Margin="0 6 0 4" TickFrequency="3.5"
                TickPlacement="BottomRight" IsSnapToTickEnabled="False" SmallChange="7" LargeChange="7" BindingMode="FromToFixed"
                mui:FancyHintsService.Hint="{Binding Id, Source={x:Static c:FancyHints.DoubleSlider}}" mui:FancyHintsService.HorizontalAlignment="Right"
                mui:FancyHintsService.AttachTo="{x:Type Thumb}" />
          </DockPanel>

          <DockPanel>
            <mui:ValueLabel Padding="8 0 0 0" Value="{Binding WindDirectionVariation, StringFormat='{}{0:F0}'}" Background="Transparent"
                Content="Wind direction variation" Width="240" Postfix="°" />
            <Slider TickFrequency="15" TickPlacement="BottomRight" Value="{Binding WindDirectionVariation}" Minimum="0" Maximum="90" />
          </DockPanel>

          <Button Content="Delete" Command="{Binding DeleteCommand}"
              Visibility="{Binding Index, Converter={StaticResource MoreToVisibilityConverter}, ConverterParameter='0,hidden'}" />
        </StackPanel>
      </DataTemplate>
    </ResourceDictionary>
  </UserControl.Resources>

  <mui:SpacingStackPanel Spacing="20">
    <mui:SpacingStackPanel Spacing="4">
      <mui:ValueLabel Value="{Binding SelectedObject.DisplayTime}" mui:BetterTextBox.Mode="Time" Content="{x:Static g:AppStrings.Drive_Time}" />
      <Slider Value="{Binding SelectedObject.Time}" TickFrequency="3600" TickPlacement="BottomRight" IsSnapToTickEnabled="False"
          Minimum="{Binding Source={x:Static a:CommonAcConsts.TimeMinimum}}" Maximum="{Binding Source={x:Static a:CommonAcConsts.TimeMaximum}}"
          SmallChange="900" LargeChange="1800" />
    </mui:SpacingStackPanel>

    <mui:SpacingStackPanel Spacing="4" Margin="0 -12 0 0">
      <mui:ValueLabel Value="{Binding SelectedObject.TimeMultiplier}" Postfix="×" Content="{x:Static g:AppStrings.Drive_TimeMultiplerLabel}" />
      <Slider Minimum="0" Maximum="1" TickFrequency="0.2" TickPlacement="None" IsSnapToTickEnabled="False">
        <Slider.Value>
          <Binding Path="SelectedObject.TimeMultiplier">
            <Binding.Converter>
              <mui:LogarithmicScale Minimum="0" Middle="20" Maximum="60" />
            </Binding.Converter>
          </Binding>
        </Slider.Value>
      </Slider>
    </mui:SpacingStackPanel>

    <CheckBox IsChecked="{Binding SelectedObject.DynamicTrackEnabled}">
      <Label>
        <TextBlock Style="{StaticResource Heading2}" Text="Dynamic Track" />
      </Label>
    </CheckBox>

    <mui:SpacingUniformGrid Margin="0 -12 0 0" HorizontalSpacing="0" VerticalSpacing="8" IsEnabled="{Binding DynamicTrackEnabled}"
        DataContext="{Binding SelectedObject}">
      <DockPanel DataContext="{Binding TrackProperties}">
        <mui:ValueLabel Value="{Binding SessionStart}" Content="Start value" Postfix="%" />
        <Slider Minimum="0" Maximum="100" TickFrequency="10" TickPlacement="BottomRight" Value="{Binding SessionStart}" />
      </DockPanel>

      <DockPanel DataContext="{Binding TrackProperties}">
        <mui:ValueLabel Value="{Binding Randomness}" Content="Randomness" Postfix="%" />
        <Slider Minimum="0" Maximum="100" TickFrequency="10" TickPlacement="BottomRight" Value="{Binding Randomness}" />
      </DockPanel>

      <DockPanel DataContext="{Binding TrackProperties}">
        <mui:ValueLabel Value="{Binding SessionTransfer}" Content="Transferred" Postfix="%" />
        <Slider Minimum="0" Maximum="100" TickFrequency="10" TickPlacement="BottomRight" Value="{Binding SessionTransfer}" />
      </DockPanel>

      <DockPanel DataContext="{Binding TrackProperties}">
        <mui:ValueLabel Value="{Binding LapGain}" Content="Laps to improve" mui:BetterTextBox.Mode="Positive"
            Postfix="{Binding LapGain, Converter={StaticResource PluralizingConverter}, ConverterParameter={x:Static c:ControlsStrings.Common_LapsPostfix}}" />
        <Slider Minimum="1" Maximum="81" TickFrequency="9" TickPlacement="BottomRight" Value="{Binding LapGain}" />
      </DockPanel>
    </mui:SpacingUniformGrid>

    <StackPanel DataContext="{Binding SelectedObject}" Style="{StaticResource SettingsPanel}">
      <TextBlock Style="{StaticResource SettingsPanel.Heading2.First}" Text="Weather" />

      <TextBlock Style="{StaticResource SettingsPanel.Small}">
        <TextBlock.Text>Weather settings are unrelated to the number of enabled sessions: each session will use a randomly selected weather from these.</TextBlock.Text>
      </TextBlock>

      <ListBox mui:Draggable.Enabled="True" mui:Draggable.Destination="{x:Static t:ServerWeatherEntry.DraggableFormat}" ScrollViewer.CanContentScroll="False"
          ScrollViewer.HorizontalScrollBarVisibility="Auto" ScrollViewer.VerticalScrollBarVisibility="Disabled">
        <ListBox.ItemTemplateSelector>
          <c:FlexibleDataTemplateSelector DataTemplate="{StaticResource WeatherDataTemplate}" />
        </ListBox.ItemTemplateSelector>
        <i:Interaction.Behaviors>
          <mui:HorizontalScrollBehavior />
        </i:Interaction.Behaviors>
        <ItemsControl.ItemsPanel>
          <ItemsPanelTemplate>
            <VirtualizingStackPanel ScrollUnit="Pixel" IsVirtualizing="True" VirtualizationMode="Recycling" Orientation="Horizontal" />
          </ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>
        <ItemsControl.Resources>
          <CollectionViewSource x:Key="Rounds" Source="{Binding Weather}" />
        </ItemsControl.Resources>
        <ItemsControl.ItemsSource>
          <CompositeCollection>
            <CollectionContainer Collection="{Binding Source={StaticResource Rounds}}" />
            <Border Height="120" Margin="20 0" Width="160">
              <Border.Resources>
                <SolidColorBrush x:Key="ButtonBackground" Color="Transparent" />
              </Border.Resources>
              <Button BorderThickness="0" Click="OnAddNewRoundButtonClick">
                <mui:SpacingStackPanel Spacing="8">
                  <Path Data="{StaticResource AddIconData}" Stretch="Fill" Width="12" Height="12" HorizontalAlignment="Center"
                      Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" Margin="0 1 0 -1" />
                  <TextBlock Text="Create New" VerticalAlignment="Center" Style="{StaticResource Heading2}" />
                </mui:SpacingStackPanel>
              </Button>
            </Border>
          </CompositeCollection>
        </ItemsControl.ItemsSource>
        <ListBox.ItemContainerStyle>
          <Style TargetType="ListBoxItem" BasedOn="{StaticResource RibbonListBoxItem.Top}">
            <Style.Triggers>
              <DataTrigger Binding="{Binding Index, FallbackValue=-1}" Value="-1">
                <Setter Property="Background" Value="Transparent" />
              </DataTrigger>
            </Style.Triggers>
          </Style>
        </ListBox.ItemContainerStyle>
      </ListBox>
    </StackPanel>
  </mui:SpacingStackPanel>
</UserControl>